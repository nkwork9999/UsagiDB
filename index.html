<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ° UsagiDB Demo</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      button {
        margin: 5px;
        padding: 8px 16px;
        cursor: pointer;
      }
      #output {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ° UsagiDB (MoonBitç‰ˆ)</h1>
    <button onclick="createDB()">Create DB</button>
    <button onclick="insertData()">Insert</button>
    <button onclick="scanData()">Scan</button>
    <button onclick="showStats()">Stats</button>
    <button onclick="serializeDB()">Serialize</button>
    <button onclick="clearOutput()">Clear</button>
    <pre id="output"></pre>

    <!-- MoonBitã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿JS -->
    <script src="./target/js/release/build/cmd/main/main.js"></script>

    <script>
      const out = document.getElementById("output");
      let db = null;

      function log(msg) {
        out.textContent += msg + "\n";
        console.log(msg);
      }

      function clearOutput() {
        out.textContent = "";
      }

      function createDB() {
        db = UsagiDB.create(50); // threshold=50
        log("âœ… DB created (threshold=50)");
      }

      function insertData() {
        if (!db) {
          log("âš ï¸ DB not created. Creating...");
          createDB();
        }

        // Int64å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½œæˆ
        const now = Date.now();
        const ts = UsagiDB.toInt64(now % 2147483647); // Intç¯„å›²å†…ã«åã‚ã‚‹
        const temp = 20 + Math.random() * 10;
        const sensor = Math.random() > 0.5 ? "sensor-1" : "sensor-2";

        // Valueé…åˆ—ã‚’ä½œæˆ
        const values = [new UsagiDB.Float(temp), new UsagiDB.String(sensor)];

        UsagiDB.insert(db, ts, values);
        log(
          `ğŸ“ Inserted: ts=${now}, temp=${temp.toFixed(2)}Â°C, sensor=${sensor}`
        );
      }

      function scanData() {
        if (!db) {
          log("âš ï¸ DB not created");
          return;
        }

        // Int64ã®ç¯„å›²: {hi, lo} å½¢å¼
        const start = { hi: 0, lo: 0 };
        const end = { hi: 0x7fffffff, lo: -1 }; // MAX_INT64

        const rows = UsagiDB.scan(db, start, end);
        log(`ğŸ“Š Scan result: ${rows.length} rows`);

        // å„è¡Œã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆæœ€å¤§10è¡Œï¼‰
        const showCount = Math.min(rows.length, 10);
        for (let i = 0; i < showCount; i++) {
          const row = rows[i];
          const tsLo = row.ts.lo >>> 0; // unsigned ã¨ã—ã¦è¡¨ç¤º
          let valStr = "";
          for (const v of row.values) {
            if (v.$tag === 2) {
              // Float
              valStr += v._0.toFixed(2) + "Â°C, ";
            } else if (v.$tag === 3) {
              // String
              valStr += v._0 + ", ";
            }
          }
          log(`  [${i}] ts=${tsLo}, ${valStr.slice(0, -2)}`);
        }
        if (rows.length > 10) {
          log(`  ... and ${rows.length - 10} more rows`);
        }
      }

      function showStats() {
        if (!db) {
          log("âš ï¸ DB not created");
          return;
        }
        const stats = UsagiDB.stats(db);
        log("ğŸ“ˆ " + stats);
      }

      function serializeDB() {
        if (!db) {
          log("âš ï¸ DB not created");
          return;
        }
        const json = UsagiDB.serialize(db);
        log(`ğŸ’¾ Serialized: ${json.length} bytes`);
        log(`   Preview: ${json.substring(0, 100)}...`);
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      log("ğŸ° UsagiDB (MoonBitç‰ˆ) loaded");
      log("   Click 'Create DB' to start");
    </script>
  </body>
</html>
